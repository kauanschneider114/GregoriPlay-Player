<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistir Player</title>

<style>
  * {margin:0; padding:0; box-sizing:border-box;}
  html, body {
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
  }

  #player-container {
    position: fixed;
    inset: 0;
    background: #000;
  }

  iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  /* Efeito de esconder controles (transparência temporária) */
  .dim iframe {
    opacity: 1;
    filter: brightness(0.99);
  }

  #touch-overlay {
    position: fixed;
    inset: 0;
    z-index: 10;
    background: transparent;
  }

  #loader {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-family: sans-serif;
    font-size: 1rem;
  }
</style>
</head>
<body>

<div id="player-container">
  <div id="loader">Carregando player...</div>
  <iframe id="vimeo-player" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
  <div id="touch-overlay"></div>
</div>

<script src="https://player.vimeo.com/api/player.js"></script>
<script>
const SEGREDO = "gregoriPlay123456";

function getQueryParams() {
  const p = new URLSearchParams(window.location.search);
  return {
    vimeo_id: p.get("vimeo_id"),
    expira: p.get("expira"),
    key: p.get("key")
  };
}

async function gerarHash(txt) {
  const buf = new TextEncoder().encode(txt);
  const hash = await crypto.subtle.digest("SHA-256", buf);
  return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2,"0")).join("");
}

async function validarHash(id, expira, key) {
  if (!key) return false;
  const texto = `${id}|${expira}|${SEGREDO}`;
  const correto = await gerarHash(texto);
  return correto === key;
}

async function iniciar() {
  const { vimeo_id, expira, key } = getQueryParams();
  const agora = Date.now();
  const loader = document.getElementById("loader");
  const container = document.getElementById("player-container");
  const overlay = document.getElementById("touch-overlay");
  const iframe = document.getElementById("vimeo-player");

  if (!vimeo_id) return loader.textContent = "Erro: ID não fornecido.";
  if (expira && parseInt(expira) < agora) return loader.textContent = "⚠️ Link expirado.";
  const ok = await validarHash(vimeo_id, expira, key);
  if (!ok) return loader.textContent = "⚠️ Link inválido ou adulterado.";

  const embedURL = `https://player.vimeo.com/video/${vimeo_id}?autoplay=1&muted=0&controls=1&portrait=0&title=0&byline=0`;
  iframe.src = embedURL;

  const player = new Vimeo.Player(iframe);

  player.on("play", async () => {
    loader.style.display = "none";

    // tenta fullscreen automático
    if (iframe.requestFullscreen) iframe.requestFullscreen().catch(()=>{});

    // mostra os controles por 4s e depois diminui o brilho (efeito de sumir)
    setTimeout(() => container.classList.add("dim"), 4000);
  });

  // se tocar na tela → mostra novamente os controles (tira efeito "dim")
  overlay.addEventListener("click", () => {
    container.classList.remove("dim");
    clearTimeout(window.hideTimeout);
    window.hideTimeout = setTimeout(() => {
      container.classList.add("dim");
    }, 4000);
  });
}

iniciar();
</script>

</body>
</html>
